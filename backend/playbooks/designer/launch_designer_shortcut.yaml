name: "Launch Designer via Shortcut"
version: "1.0"
description: "Launch Ignition Designer application"
domain: designer
group: "Designer (Base Playbooks)"
verified: true

parameters:
  - name: designer_shortcut
    type: string
    required: true
    description: "Full Designer launcher shortcut command"

  - name: project_name
    type: string
    required: true
    description: "Name of the Designer project to open"

  - name: gateway_credential
    type: credential
    required: true
    description: "Gateway credential to use for Designer login"

steps:
  # Step 1: Launch Designer and wait for login window
  - id: launch_designer
    name: "Step 1: Launch Designer and wait for login window"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import asyncio
        import time

        designer_shortcut = r"""{{ designer_shortcut }}"""

        print(f"[1/3] Launching Ignition Designer...")

        # Parse shortcut to extract executable and arguments
        parts = designer_shortcut.split(" -D", 1)
        designer_exe = parts[0].strip().strip('"')

        if len(parts) > 1:
            args = "-D" + parts[1]
            launch_cmd = f'powershell.exe -NoLogo -NoProfile -Command "Start-Process \\"{designer_exe}\\" -ArgumentList \\"{args}\\""'
        else:
            launch_cmd = f'powershell.exe -NoLogo -NoProfile -Command "Start-Process \\"{designer_exe}\\""'

        # Launch Designer
        proc = subprocess.Popen(launch_cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        proc.wait()

        print("Waiting for login window...")
        designer_timeout = timeout_overrides.get("designer_launch", 60)
        sleep_interval = 5
        max_attempts = max(1, designer_timeout // sleep_interval)
        attempt = 0
        login_window = False

        while attempt < max_attempts:
            # Use list form to avoid shell expansion of $_ variable
            check_cmd = [
                "powershell.exe", "-NoLogo", "-NoProfile",
                "-Command",
                "Get-Process | Where-Object {$_.MainWindowTitle -eq 'Login - Ignition'} | Measure-Object | Select-Object -ExpandProperty Count"
            ]
            result = subprocess.run(check_cmd, capture_output=True, text=True)
            count = result.stdout.strip()

            if count and count != "0":
                print("✓ Login window detected!")
                login_window = True
                break

            attempt += 1
            if attempt < max_attempts:
                print(f"  Checking... (attempt {attempt}/{max_attempts})")
                time.sleep(5)

        if not login_window:
            raise Exception(f"Login window did not appear after {designer_timeout} seconds")

        # Wait for UI to fully initialize (Java Swing needs time after window appears)
        print("Allowing login window to fully initialize...")
        time.sleep(2)

        print("LOGIN_WINDOW_READY=true")
    timeout: 60
    on_failure: abort

  # Step 2: Enter credentials and login
  - id: login
    name: "Step 2: Enter credentials and login"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import tempfile
        import time
        import os

        username = r"""{{ parameter.gateway_credential.username }}"""
        password = r"""{{ parameter.gateway_credential.password }}"""

        print(f"[2/3] Entering credentials for user: {username}")

        # Write PowerShell login script to a temp file at runtime
        # (external .ps1 files are not bundled in PyInstaller frozen builds)
        PS_LOGIN_SCRIPT = r'''
        param(
            [string]$Username,
            [string]$Password
        )

        Add-Type -AssemblyName System.Windows.Forms

        $designer = Get-Process | Where-Object {$_.MainWindowTitle -eq 'Login - Ignition'} | Select-Object -First 1

        if ($designer) {
            Add-Type -TypeDefinition @'
            using System;
            using System.Runtime.InteropServices;
            public class Win32 {
                [DllImport("user32.dll")]
                public static extern bool SetForegroundWindow(IntPtr hWnd);
                [DllImport("user32.dll")]
                public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
            }
        '@

            [Win32]::ShowWindow($designer.MainWindowHandle, 9)
            Start-Sleep -Milliseconds 500
            [Win32]::SetForegroundWindow($designer.MainWindowHandle)
            Start-Sleep -Milliseconds 300
            [Win32]::SetForegroundWindow($designer.MainWindowHandle)
            Start-Sleep -Milliseconds 300
            [Win32]::SetForegroundWindow($designer.MainWindowHandle)
            Start-Sleep -Milliseconds 800

            [System.Windows.Forms.SendKeys]::SendWait($Username)
            Start-Sleep -Milliseconds 100
            [System.Windows.Forms.SendKeys]::SendWait('{TAB}')
            Start-Sleep -Milliseconds 100
            [System.Windows.Forms.SendKeys]::SendWait($Password)
            Start-Sleep -Milliseconds 100
            [System.Windows.Forms.SendKeys]::SendWait('{ENTER}')

            Write-Output 'success'
        } else {
            Write-Output 'failed - window not found'
        }
        '''

        # Write to temp file and execute (temp file avoids path/bundling issues)
        fd, ps_file = tempfile.mkstemp(suffix='.ps1')
        try:
            os.write(fd, PS_LOGIN_SCRIPT.encode('utf-8'))
            os.close(fd)

            result = subprocess.run(
                ["powershell.exe", "-NoLogo", "-NoProfile", "-ExecutionPolicy", "Bypass",
                 "-File", ps_file, "-Username", username, "-Password", password],
                capture_output=True, text=True
            )
        finally:
            try:
                os.unlink(ps_file)
            except OSError:
                pass

        output_lines = result.stdout.strip().split('\n')

        if not any(line.strip() == "success" for line in output_lines):
            raise Exception(f"Failed to enter credentials. stdout: {result.stdout.strip()} stderr: {result.stderr.strip()}")

        print("✓ Credentials entered successfully")

        # Wait for project selection screen
        print("Waiting for project selection...")
        designer_timeout = timeout_overrides.get("designer_launch", 60)
        sleep_interval = 3
        max_attempts = max(1, designer_timeout // sleep_interval)
        attempt = 0
        project_window = False

        while attempt < max_attempts:
            check_cmd = [
                "powershell.exe", "-NoLogo", "-NoProfile",
                "-Command",
                "Get-Process | Where-Object {$_.MainWindowTitle -like '*Open/Create Project*'} | Measure-Object | Select-Object -ExpandProperty Count"
            ]
            result = subprocess.run(check_cmd, capture_output=True, text=True)
            count = result.stdout.strip()

            if count and count != "0":
                print("✓ Project selection screen detected!")
                project_window = True
                break

            attempt += 1
            if attempt < max_attempts:
                print(f"  Checking... (attempt {attempt}/{max_attempts})")
                time.sleep(3)

        if not project_window:
            raise Exception(f"Project selection screen did not appear after {designer_timeout} seconds. Login may have failed.")

        print("PROJECT_SELECTION_READY=true")
    timeout: 60
    on_failure: abort

  # Step 3: Search and open project
  - id: open_project
    name: "Step 3: Search and open project"
    type: utility.python
    parameters:
      script: |
        import subprocess
        import tempfile
        import time
        import os

        project_name = r"""{{ project_name }}"""

        print(f"[3/3] Opening project '{project_name}'...")

        # Write PowerShell project opener script to a temp file at runtime
        # (external .ps1 files are not bundled in PyInstaller frozen builds)
        PS_PROJECT_SCRIPT = r'''
        param(
            [string]$ProjectName
        )

        Add-Type -AssemblyName System.Windows.Forms
        Add-Type -AssemblyName System.Drawing

        $designer = Get-Process | Where-Object {$_.MainWindowTitle -like '*Open/Create Project*'} | Select-Object -First 1

        if ($designer) {
            Add-Type -TypeDefinition @'
            using System;
            using System.Runtime.InteropServices;
            public class Win32 {
                [DllImport("user32.dll")]
                public static extern bool SetForegroundWindow(IntPtr hWnd);
                [DllImport("user32.dll")]
                public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
                [DllImport("user32.dll")]
                public static extern bool GetWindowRect(IntPtr hWnd, out RECT lpRect);

                [StructLayout(LayoutKind.Sequential)]
                public struct RECT {
                    public int Left;
                    public int Top;
                    public int Right;
                    public int Bottom;
                }
            }
        '@

            [Win32]::ShowWindow($designer.MainWindowHandle, 9)
            Start-Sleep -Milliseconds 200
            [Win32]::SetForegroundWindow($designer.MainWindowHandle)
            Start-Sleep -Milliseconds 200
            [Win32]::SetForegroundWindow($designer.MainWindowHandle)
            Start-Sleep -Milliseconds 300

            $rect = New-Object Win32+RECT
            [Win32]::GetWindowRect($designer.MainWindowHandle, [ref]$rect)

            $windowWidth = $rect.Right - $rect.Left
            $windowHeight = $rect.Bottom - $rect.Top

            $searchX = $rect.Left + ($windowWidth * 0.5)
            $searchY = $rect.Top + ($windowHeight * 0.2)
            [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point($searchX, $searchY)
            Start-Sleep -Milliseconds 100

            Add-Type -TypeDefinition @'
            using System;
            using System.Runtime.InteropServices;
            public class MouseClick {
                [DllImport("user32.dll")]
                public static extern void mouse_event(int dwFlags, int dx, int dy, int cButtons, int dwExtraInfo);
                public const int MOUSEEVENTF_LEFTDOWN = 0x02;
                public const int MOUSEEVENTF_LEFTUP = 0x04;
            }
        '@

            [MouseClick]::mouse_event([MouseClick]::MOUSEEVENTF_LEFTDOWN, 0, 0, 0, 0)
            Start-Sleep -Milliseconds 50
            [MouseClick]::mouse_event([MouseClick]::MOUSEEVENTF_LEFTUP, 0, 0, 0, 0)
            Start-Sleep -Milliseconds 150

            [System.Windows.Forms.SendKeys]::SendWait('^a')
            Start-Sleep -Milliseconds 50
            [System.Windows.Forms.SendKeys]::SendWait($ProjectName)
            Start-Sleep -Milliseconds 200

            $projectRowX = $rect.Left + ($windowWidth * 0.20)
            $projectRowY = $rect.Top + ($windowHeight * 0.32)
            [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point($projectRowX, $projectRowY)
            Start-Sleep -Milliseconds 150

            [MouseClick]::mouse_event([MouseClick]::MOUSEEVENTF_LEFTDOWN, 0, 0, 0, 0)
            Start-Sleep -Milliseconds 50
            [MouseClick]::mouse_event([MouseClick]::MOUSEEVENTF_LEFTUP, 0, 0, 0, 0)
            Start-Sleep -Milliseconds 100
            [MouseClick]::mouse_event([MouseClick]::MOUSEEVENTF_LEFTDOWN, 0, 0, 0, 0)
            Start-Sleep -Milliseconds 50
            [MouseClick]::mouse_event([MouseClick]::MOUSEEVENTF_LEFTUP, 0, 0, 0, 0)

            Write-Output 'success'
        } else {
            Write-Output 'failed - window not found'
        }
        '''

        # Write to temp file and execute (temp file avoids path/bundling issues)
        fd, ps_file = tempfile.mkstemp(suffix='.ps1')
        try:
            os.write(fd, PS_PROJECT_SCRIPT.encode('utf-8'))
            os.close(fd)

            result = subprocess.run(
                ["powershell.exe", "-NoLogo", "-NoProfile", "-ExecutionPolicy", "Bypass",
                 "-File", ps_file, "-ProjectName", project_name],
                capture_output=True, text=True
            )
        finally:
            try:
                os.unlink(ps_file)
            except OSError:
                pass

        output_lines = result.stdout.strip().split('\n')

        if not any(line.strip() == "success" for line in output_lines):
            raise Exception(f"Failed to open project. stdout: {result.stdout.strip()} stderr: {result.stderr.strip()}")

        print("")
        print("=" * 50)
        print("✓ Project opening initiated!")
        print("=" * 50)
        print(f"The project '{project_name}' should now be opening in Designer.")

        # Wait and verify project opened
        time.sleep(5)
        verify_cmd = [
            "powershell.exe", "-NoLogo", "-NoProfile",
            "-Command",
            "Get-Process | Where-Object {($_.ProcessName -eq 'java') -or ($_.ProcessName -eq 'javaw')} | Select-Object -ExpandProperty MainWindowTitle"
        ]
        result = subprocess.run(verify_cmd, capture_output=True, text=True)
        window_titles = result.stdout

        if project_name.lower() in window_titles.lower():
            print(f"✓ CONFIRMED: Project '{project_name}' is now open!")
        else:
            print("⚠ Could not verify project opened. Please check the Designer window.")

        print("PROJECT_OPENED=true")
    timeout: 60
    on_failure: abort
